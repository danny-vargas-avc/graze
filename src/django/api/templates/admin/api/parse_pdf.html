{% extends "admin/base_site.html" %}
{% load i18n %}

{% block title %}Parse Nutrition PDF{% endblock %}

{% block content %}
<div style="max-width: 1200px; margin: 0 auto; padding: 24px 0;">
  <h1 style="font-size: 24px; font-weight: 700; margin-bottom: 8px;">Parse Nutrition PDF</h1>
  <p style="color: #6b7280; margin-bottom: 24px;">Upload a nutrition PDF to auto-parse menu items using AI.</p>

  {% if not parsed_items %}
  <!-- Step 1: Upload PDF -->
  <form method="post" enctype="multipart/form-data" style="max-width: 720px; background: var(--color-bg, white); border: 1px solid #e5e7eb; border-radius: 12px; padding: 24px;">
    {% csrf_token %}

    <div style="margin-bottom: 20px;">
      <label style="display: block; font-weight: 600; margin-bottom: 6px;">Restaurant</label>
      <select name="restaurant" required style="width: 100%; padding: 10px 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 14px;">
        <option value="">Select a restaurant...</option>
        {% for r in restaurants %}
        <option value="{{ r.pk }}">{{ r.name }}</option>
        {% endfor %}
      </select>
    </div>

    <div style="margin-bottom: 20px;">
      <label style="display: block; font-weight: 600; margin-bottom: 6px;">Nutrition PDF</label>
      <input type="file" name="pdf_file" accept=".pdf" required style="font-size: 14px;" />
    </div>

    <button type="submit" style="background: #059669; color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer;">
      Parse PDF
    </button>
  </form>

  {% else %}
  <!-- Step 2: Review and confirm parsed items -->
  <form method="post">
    {% csrf_token %}
    <input type="hidden" name="restaurant" value="{{ restaurant.pk }}" />
    <input type="hidden" name="confirm" value="1" />
    <input type="hidden" name="item_count" value="{{ item_count }}" />

    <div style="margin-bottom: 16px; display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
      <span style="font-weight: 600;">{{ item_count }} items parsed for {{ restaurant.name }}</span>
      <button type="submit" style="background: #059669; color: white; border: none; padding: 8px 20px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer;">
        Confirm &amp; Import Selected
      </button>
      <a href="{% url 'parse_nutrition_pdf' %}" style="color: #6b7280; text-decoration: none; font-size: 14px;">Cancel</a>
    </div>

    <div style="overflow-x: auto; border: 1px solid #e5e7eb; border-radius: 12px;">
      <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
        <thead>
          <tr style="background: #f9fafb; border-bottom: 1px solid #e5e7eb;">
            <th style="padding: 10px 12px; text-align: left; font-weight: 600;">Include</th>
            <th style="padding: 10px 12px; text-align: left; font-weight: 600;">Name</th>
            <th style="padding: 10px 12px; text-align: left; font-weight: 600;">Category</th>
            <th style="padding: 10px 12px; text-align: left; font-weight: 600;">Serving</th>
            <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Cal</th>
            <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Protein</th>
            <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Carbs</th>
            <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Fat</th>
            <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Fiber</th>
            <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Sodium</th>
            <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Sugar</th>
            <th style="padding: 10px 12px; text-align: right; font-weight: 600;">Sat Fat</th>
          </tr>
        </thead>
        <tbody>
          {% for item in parsed_items %}
          <tr style="border-bottom: 1px solid #f3f4f6;">
            <td style="padding: 8px 12px;">
              <input type="checkbox" name="include_{{ forloop.counter0 }}" value="1" checked />
            </td>
            <td style="padding: 8px 12px;">
              <input type="text" name="name_{{ forloop.counter0 }}" value="{{ item.name }}" style="width: 100%; min-width: 140px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px;" />
            </td>
            <td style="padding: 8px 12px;">
              <input type="text" name="category_{{ forloop.counter0 }}" value="{{ item.category }}" style="width: 100%; min-width: 80px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px;" />
            </td>
            <td style="padding: 8px 12px;">
              <input type="text" name="serving_size_{{ forloop.counter0 }}" value="{{ item.serving_size }}" style="width: 80px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px;" />
            </td>
            <td style="padding: 8px 12px;">
              <input type="number" name="calories_{{ forloop.counter0 }}" value="{{ item.calories }}" style="width: 60px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; text-align: right;" />
            </td>
            <td style="padding: 8px 12px;">
              <input type="number" step="0.1" name="protein_{{ forloop.counter0 }}" value="{{ item.protein }}" style="width: 60px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; text-align: right;" />
            </td>
            <td style="padding: 8px 12px;">
              <input type="number" step="0.1" name="carbs_{{ forloop.counter0 }}" value="{{ item.carbs }}" style="width: 60px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; text-align: right;" />
            </td>
            <td style="padding: 8px 12px;">
              <input type="number" step="0.1" name="fat_{{ forloop.counter0 }}" value="{{ item.fat }}" style="width: 60px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; text-align: right;" />
            </td>
            <td style="padding: 8px 12px;">
              <input type="number" step="0.1" name="fiber_{{ forloop.counter0 }}" value="{{ item.fiber }}" style="width: 60px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; text-align: right;" />
            </td>
            <td style="padding: 8px 12px;">
              <input type="number" name="sodium_{{ forloop.counter0 }}" value="{{ item.sodium }}" style="width: 60px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; text-align: right;" />
            </td>
            <td style="padding: 8px 12px;">
              <input type="number" step="0.1" name="sugar_{{ forloop.counter0 }}" value="{{ item.sugar }}" style="width: 60px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; text-align: right;" />
            </td>
            <td style="padding: 8px 12px;">
              <input type="number" step="0.1" name="saturated_fat_{{ forloop.counter0 }}" value="{{ item.saturated_fat }}" style="width: 60px; padding: 4px 8px; border: 1px solid #e5e7eb; border-radius: 4px; font-size: 13px; text-align: right;" />
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="margin-top: 16px;">
      <button type="submit" style="background: #059669; color: white; border: none; padding: 10px 24px; border-radius: 8px; font-weight: 600; font-size: 14px; cursor: pointer;">
        Confirm &amp; Import Selected
      </button>
      <a href="{% url 'parse_nutrition_pdf' %}" style="margin-left: 12px; color: #6b7280; text-decoration: none; font-size: 14px;">Cancel</a>
    </div>
  </form>
  {% endif %}
</div>
{% endblock %}
